//=========================================================================
//  @package      Wicle
//  @module       ui/components/nav
//  @description  Navigation menu with dropdown and accordion support
//
//  @concept: 3 kind of nav types are possible
//    w-nav --- accordion(default) ==> class='w-nav' or 'w-nav w-o-accordion'
//           +- dropdown --- vertical(default) ==> currently not supported
//                        +- horizontal ==> class='w-nav w-o-dropdown'
//  @usage
//    <ul id="menu1">
//      <li><a href="#">Link</a></li>...
//    </ul>
//    <script> Wicle.nav('#menu1', {...}); </script>
//
//  @options
//    .wo-accordion:          make w-nav accordion (optional)
//    .wo-dropdown:           make w-nav dropdown
//
//=========================================================================

@import "../../../wdk/wdk";

// shortcut function: valid only in this file
@function cv($path:null) {  @return gsv('w-nav', $path);  }


//-----------------------------------------------
// mixin's
//-----------------------------------------------
@mixin w-nav-init {
  @if mixin-exists(w-hook-nav-init) { @include w-hook-nav-init(); }

  //--- globals variables
  $w-nav-generate-classes: true !default !global; // enable class generation

  //-- local variables
  $key: 'w-nav';

  //--- nav (ul: top level)
  @include ssv($key, 'z-index', $w-z-index, true);
  @include ssv($key, 'font-family', $w-font-sans, true);
  @include ssv($key, 'font-weight', normal, true);
  @include ssv($key, 'font-size', 1rem, true);
  @include ssv($key, 'padding', 0, true);
  @include ssv($key, 'border', null, true);
  @include ssv($key, 'radius', $w-border-radius, true);
  @include ssv($key, 'fg', $w-color-text-black, true);
  @include ssv($key, 'bg', tint($w-color-theme, 98%), true);

  //--- item (li)
  @include ssv($key, 'item/padding', 0, true);

  //--- text (li > a)
  @include ssv($key, 'item-wrapper/margin', 0, true);
  @include ssv($key, 'item-wrapper/padding', 0.35rem 0.5rem, true);
  @include ssv($key, 'item-wrapper/line-height', 1.5rem, true);
  @include ssv($key, 'item-wrapper/fg', cv(fg), true);
  @include ssv($key, 'item-wrapper/bg', null, true);
  @include ssv($key, 'item-wrapper/hover/fg', white, true);
  @include ssv($key, 'item-wrapper/hover/bg', rgba($w-color-theme, 0.90), true);

  //--- nav icon options
  @include ssv($key, 'icon/font-size', 1.25rem, true);
  @include ssv($key, 'icon/font-weight', null, true);
  @include ssv($key, 'icon/padding', 0.1rem, true);

  //--- separator for top level horizontal menu
  @include ssv($key, 'separator/height', 1.2rem, true);
  @include ssv($key, 'separator/spacing', 3px, true);
  @include ssv($key, 'separator/style', 1px solid rgba($w-color-text-black, 0.5), true);

  //--- divider for dropdown
  @include ssv($key, 'divider/spacing', 5px, true);
  @include ssv($key, 'divider/style', 1px solid $w-color-theme-line, true);  // color #ddd = gray(86.5%)

  //--- dropdown
  @include ssv($key, 'dropdown/padding', 0.5rem 0, true);
  @include ssv($key, 'dropdown/min-width', 12rem, true);
  @include ssv($key, 'dropdown/border', 1px solid $w-color-theme-line, true);

  @include ssv($key, 'dropdown/top-level/offset', 0.5rem, true);
  @include ssv($key, 'dropdown/top-level/fg', $w-color-text-white, true);

  //--- accordion
  @include ssv($key, 'accordion/padding', 0 0 0 1rem, true);
  @include ssv($key, 'accordion/header/padding', 0.25rem 0.5rem, true);
  @include ssv($key, 'accordion/click-area-size', 2.5rem, true);

  //--- options
  @include ssv($key, 'opt/invert/fg', gray(85%), true);
  @include ssv($key, 'opt/invert/hover/fg', white, true);
  @include ssv($key, 'opt/invert/separator/style', 1px solid rgba($w-color-text-white, 0.35), true);

  @include ssv($key, 'opt/flip/x-offset', 3px, true);


  @if mixin-exists(w-hook-nav-override) { @include w-hook-nav-override(); }
}

@mixin w-nav-core {
  display: inline-block;
  position:relative;
  box-sizing: border-box;
  list-style: none;
  margin: 0;
  outline: 0;

  z-index: cv(z-index);
  font-family: cv(font-family), $w-font-serif;
  font-size: cv(font-size);
  font-weight: cv(font-weight);
  padding: cv(padding);

  li {
    margin: 0;
    cursor: pointer;
    width: auto;
    position: relative; // important: required to make submenu(ul) to position relative to parent li
  }

  a {
    display: block;
    outline: none;
    margin: cv('item-wrapper/margin');
    text-decoration:none;
    padding: cv(item-wrapper/padding);
    line-height: cv(item-wrapper/line-height);
  }
  ul { display: none; }

  //--- border radius
  $radius: cv(radius);
  &, li, a {
    border-radius: $radius;
  }
  @include w-clearfix();
}

@mixin w-nav-parent-marker {
  .w-nav-parent-marker {
    float: right;
    font-family: $w-font-sans;
    margin-left: 0.5rem; // $parent-marker-margin;
    font-size: 70%;
    transition: transform 0.5s ease-in-out;
    &:before {
      content: '\25BC'; // unicode down triangle character
    }
    @content;
  }
}

@mixin w-nav-dropdown-core {
  @include w-nav-parent-marker;
  li:hover > .w-nav-item-wrapper > .w-nav-parent-marker {
    transform: rotate(-90deg);
  }

  ul {
    display: block;
    z-index: cv(z-index) + 1000;
    position: absolute;
    transform: scaleY(0);  // hide submenu
    opacity: 0;
    transform-origin: 50% 0;
    transition: opacity 0.25s, transform 0.25s ease-in;

    // set submenu out-of-viewport position
    &[aria-flip*=x] {
      left: auto;
      right: calc(100% - #{cv('opt/flip/x-offset')});
    }
    &[aria-flip*=y] {
      top: auto;
      bottom: 0;
    }

    // delay for hover-off to prevent submenu from disappearing too soon when mouse is out from li
    transition-delay: 0.25s;
    top: 0;
    left: 100%;
    margin: 0;
    padding: cv('dropdown/padding');
    list-style: none;
    &>li {
      clear: both;
      min-width: cv(dropdown/min-width);
    }
    background: cv(bg);
    border: cv(dropdown/border);
    border-radius: cv(radius);
  }

  li:hover>ul {
    transform: scaleY(1);

    // fade effect
    opacity: 1;
    transition: opacity 0.25s linear;
  }

  // fix submenu position for horizontal menu
  &.wo-default,
  &.wo-horizontal {
    &>li {
      & > ul {
        top: calc(100% + #{cv('dropdown/top-level/offset')});
        left: 0;
        // set submenu out-of-viewport position
        &[aria-flip*=x] {
          left: auto;
          right: 0;
        }
        &[aria-flip*=y] {
          top: auto;
          bottom: 100%;
        }
      }
      &:hover > .w-nav-item-wrapper > .w-nav-parent-marker {
        transform: rotate(0deg);
      }
    }
  }

  .w-nav-divider {
    margin: cv(divider/spacing) 0;
    height: 0;
    font-size: 0;
    line-height: 0;
    border: cv(divider/style);
    border-width: 1px 0 0 0;
  }
}

@mixin w-nav-accordion-core {
  @include w-nav-parent-marker {
    transform: rotate(90deg);
  };
  .aria-state-active,
  .w-nav-parent-marker {
    transform: rotate(0deg);
  }

  display: block;
  ul {
    list-style: none;
    padding: cv('accordion/padding');
  }

  .w-nav-accordion-click-area {
    position: absolute;
    top:0;
    right:0;
    height: 100%;
    width: cv(accordion/click-area-size);
    cursor: pointer;
  }
}

@mixin w-nav-options {
  // horizontal menu
  &.wo-default,
  &.wo-horizontal {
    & > li { float: left; }
    // disable marker animation for top level horizontal menu
    & > li > .aria-state-active .w-nav-parent-marker {
      transform: rotate(0deg);
    }

    // top-level menu-item separators
    &.wo-separators {
      $height: cv(separator/height);
      $spacing: cv(separator/spacing);
      $style: cv(separator/style);

      &>li {
        &:before {
          content: "";
          display: inline-block;
          position: absolute;

          width: 1px;
          height: $height;
          top: 50%;
          left: -1px - px($spacing);
          transform: translateY(-50%);
        }
        &:not(:first-child) {
          margin-top: 0;
          margin-left: px($spacing) * 2;
          &:before {
            margin: 0 1px;
            border-left: $style;
          }
        }
      }
    }

    // top-level submenu panel pointer
    &.wo-default,
    &.wo-pointers {
      &>li.w-nav-parent {
        &:after {
          border-style: solid;
          border-color: transparent transparent cv(bg);
          border-width: 0 6px 6px;
          content: "";
          opacity: 0;
          height: 0;
          position: absolute;
          left: 1.5rem;
          bottom: -1px - px(cv('dropdown/top-level/offset'));
          width: 0;
          z-index: 100000;
          transition: opacity 0.25s, transform 0.25s ease-in;
          transition-delay: 0.25s;
        }
        &:hover:after {
          opacity: 1;
          transition: opacity 0.25s linear;
        }
      }
    }
  }

  // icon menu
  &.wo-icon > li {
    & > a {
      font-size: cv(icon/font-size);
      font-weight: cv(icon/font-weight);
      padding: cv(icon/padding);
    }
  }

  &.wo-default,
  &.wo-dropdown {
    @include w-nav-dropdown-core;
  }

  &.wo-accordion {
    @include w-nav-accordion-core;
  }
}

@mixin w-nav-styles($conf:()) {
  $conf:            map-extend((), gsv('w-nav'), $conf, true);
  $bg:              gcv($conf, bg);
  $text-fg:         gcv($conf, item-wrapper/fg);
  $text-bg:         gcv($conf, item-wrapper/bg);
  $hover-fg:        gcv($conf, 'item-wrapper/hover/fg');
  $hover-bg:        gcv($conf, 'item-wrapper/hover/bg');

  background-color: $bg;
  li {
    color: cv(fg);    // default text color for menu items
    a {
      color: $text-fg;
      background: $text-bg;
    }
    &:hover > a {
      color: $hover-fg;
      background: $hover-bg;
    }
  }

  &.wo-default,
  &.wo-horizontal {
    background: transparent;
    &>li, &>li>a {
      background: transparent;
    }
    &>li:hover {
      background: transparent;
      &>.w-nav-item-wrapper {
        color: cv('item-wrapper/hover/fg');
      }
    }
  }
  &.wo-invert {
    &>li {
      &>a {
        color: cv('opt/invert/fg');
      }
      &:hover>a {
        color: cv('opt/invert/hover/fg');
      }
    }

    &.wo-separators {
      &>li:not(:first-child):before {
        border-left: cv('opt/invert/separator/style');
      }
    }
  }
}


//-----------------------------------------------
//  module init
//-----------------------------------------------
@include w-nav-init;


//-----------------------------------------------
//  class generation
//-----------------------------------------------
@if $w-wicle-mode == 'css' and $w-nav-generate-classes {
  .w-nav {
    @include w-nav-core;
    @include w-nav-options;
    @include w-nav-styles;
  }
}

@if mixin-exists(w-hook-nav) { @include w-hook-nav(); }