//=========================================================================
//  @package      Wicle
//  @module       ui/components/nav
//  @description  Navigation menu with dropdown and accordion support
//
//  @concept: 3 kind of nav types are possible
//    w-nav --- accordion(default) ==> class='w-nav' or 'w-nav w-o-accordion'
//           +- dropdown --- vertical(default) ==> currently not supported
//                        +- horizontal ==> class='w-nav w-o-dropdown'
//  @usage
//    <ul id="menu1">
//      <li><a href="#">Link</a></li>...
//    </ul>
//    <script> Wicle.nav('#menu1', {...}); </script>
//
//  @options
//    .wo-accordion:          make w-nav accordion (optional)
//    .wo-dropdown:           make w-nav dropdown
//
//=========================================================================

@import "wdk/wdk";

//-----------------------------------------------
//  data
//-----------------------------------------------
$w-nav-generate-classes:     true !default;   // enable class generation
$w-conf-nav: ();

//--- nav (ul: top level)
$w-conf-nav: scv($w-conf-nav, 'z-index', $w-z-index, true);
$w-conf-nav: scv($w-conf-nav, 'font-family', Arial, true);
$w-conf-nav: scv($w-conf-nav, 'font-weight', normal, true);
$w-conf-nav: scv($w-conf-nav, 'font-size', 1rem, true);
$w-conf-nav: scv($w-conf-nav, 'padding', 0, true);
$w-conf-nav: scv($w-conf-nav, 'border', null, true);
$w-conf-nav: scv($w-conf-nav, 'radius', $w-border-radius, true);
$w-conf-nav: scv($w-conf-nav, 'bg', $w-color-text-white, true);

//--- item (li)
$w-conf-nav: scv($w-conf-nav, 'item/padding', 0, true);

//--- text (li > a)
//$w-conf-nav: scv($w-conf-nav, 'text/margin', 0, true);
$w-conf-nav: scv($w-conf-nav, 'item-wrapper/margin', 0, true);
$w-conf-nav: scv($w-conf-nav, 'item-wrapper/padding', 0.25rem 0.5rem, true);
$w-conf-nav: scv($w-conf-nav, 'item-wrapper/line-height', 1.5rem, true);
$w-conf-nav: scv($w-conf-nav, 'item-wrapper/fg', $w-color-text-black, true);
$w-conf-nav: scv($w-conf-nav, 'item-wrapper/bg', $w-color-text-white, true);
$w-conf-nav: scv($w-conf-nav, 'item-wrapper/hover/fg', $w-color-text-white, true);
$w-conf-nav: scv($w-conf-nav, 'item-wrapper/hover/bg', $w-color-lochmara, true);

//--- nav icon options
$w-conf-nav: scv($w-conf-nav, 'icon/font-size', 1.25rem, true);
$w-conf-nav: scv($w-conf-nav, 'icon/font-weight', null, true);
$w-conf-nav: scv($w-conf-nav, 'icon/padding', 0.1rem, true);

//--- separator for top level horizontal menu
$w-conf-nav: scv($w-conf-nav, 'separator/height', 1.2rem, true);
$w-conf-nav: scv($w-conf-nav, 'separator/spacing', 3px, true);
$w-conf-nav: scv($w-conf-nav, 'separator/style', 1px solid transparentize($w-color-text-black, 0.65), true);

//--- divider for dropdown
$w-conf-nav: scv($w-conf-nav, 'divider/spacing', 5px, true);
$w-conf-nav: scv($w-conf-nav, 'divider/style', 1px solid gray(80%), true);  // color #ddd = gray(86.5%)

//--- dropdown
$w-conf-nav: scv($w-conf-nav, 'dropdown/min-width', 12rem, true);
$w-conf-nav: scv($w-conf-nav, 'dropdown/border', 1px solid transparentize($w-color-text-black, 0.65), true);

//--- accordion
$w-conf-nav: scv($w-conf-nav, 'accordion/padding', 0 0 0 1rem, true);
$w-conf-nav: scv($w-conf-nav, 'accordion/header/padding', 0.25rem 0.5rem, true);
$w-conf-nav: scv($w-conf-nav, 'accordion/click-area-size', 2.5rem, true);


//=== data interface
@mixin scv-nav($path, $value, $default:false) {
  $w-conf-nav: scv($w-conf-nav, $path, $value, $default) !global;
}

@mixin scv-nav-merge($conf) {
  $w-conf-nav: map-merge($w-conf-nav, $conf) !global;
}

@function gcv-nav($path) {
  @return gcv($w-conf-nav, $path);
}



//-----------------------------------------------
// mixin's
//-----------------------------------------------
@mixin w-nav-core {
  display: inline-block;
  position:relative;
  box-sizing: border-box;
  list-style: none;
  margin: 0;
  outline: 0;

  z-index: gcv-nav(z-index);
  font-family: gcv-nav(font-family), $w-font-serif;
  font-size: gcv-nav(font-size);
  font-weight: gcv-nav(font-weight);
  padding: gcv-nav(padding);

  li {
    margin: 0;
    cursor: pointer;
    color: inherit;
    width: auto;
    position: relative; // important: required to make submenu(ul) to position relative to parent li
  }

  a {
    display: block;
    outline: none;
    color: inherit;
    margin: gcv($w-conf-nav, 'item-wrapper/margin');
    text-decoration:none;
    padding: gcv-nav(item-wrapper/padding);
    line-height: gcv-nav(item-wrapper/line-height);
  }
  ul { display: none; }

  //--- border radius
  $radius: gcv-nav(radius);
  &, li, a {
    border-radius: $radius;
  }
  @include w-clearfix();
}

@mixin w-nav-parent-marker {
  .w-nav-parent-marker {
    float: right;
    font-family: $w-font-sans;
    margin-left: 0.5rem; // $parent-marker-margin;
    font-size: 70%;
    transition: transform 0.5s ease-in-out;
    &:before {
      content: '\25BC'; // unicode down triangle character
    }
    @content;
  }
}

@mixin w-nav-dropdown-core {
  @include w-nav-parent-marker;
  li:hover > .w-nav-item-wrapper > .w-nav-parent-marker {
    transform: rotate(-90deg);
  }

  ul {
    display: block;
    z-index: gcv-nav(z-index) + 1000;
    position: absolute;
    transform: scaleY(0);  // hide submenu
    opacity: 0;
    transform-origin: 50% 0;
    transition: opacity 0.25s, transform 0.25s ease-in;

    // set submenu out-of-viewport position
    &[aria-flip*=x] {
      left: auto;
      right: 100%;
    }
    &[aria-flip*=y] {
      top: auto;
      bottom: 0;
    }

    // delay for hover-off to prevent submenu from disappearing too soon when mouse is out from li
    transition-delay: 0.25s;
    top: 0;
    left: 100%;
    margin: 0;
    padding:0;
    list-style: none;
    &>li {
      clear: both;
      min-width: gcv-nav(dropdown/min-width);
    }
    background: gcv-nav(bg);
    border: gcv-nav(dropdown/border);
    border-radius: gcv-nav(radius);
  }

  li:hover>ul {
    transform: scaleY(1);

    // fade effect
    opacity: 1;
    transition: opacity 0.25s linear;
  }

  // fix submenu position for horizontal menu
  &.wo-horizontal {
    &>li {
      & > ul {
        top: 100%;
        left: 0;
        // set submenu out-of-viewport position
        &[aria-flip*=x] {
          left: auto;
          right: 0;
        }
        &[aria-flip*=y] {
          top: auto;
          bottom: 100%;
        }
      }
      &:hover > .w-nav-item-wrapper > .w-nav-parent-marker {
        transform: rotate(0deg);
      }
    }
  }

  .w-nav-divider {
    margin: gcv-nav(divider/spacing) 0;
    height: 0;
    font-size: 0;
    line-height: 0;
    border: gcv-nav(divider/style);
    border-width: 1px 0 0 0;
  }
}

@mixin w-nav-accordion-core {
  @include w-nav-parent-marker {
    transform: rotate(90deg);
  };
  .w-state-active .w-nav-parent-marker {
    transform: rotate(0deg);
  }

  display: block;
  ul {
    list-style: none;
    padding: gcv-nav('accordion/padding');
  }

  .w-nav-accordion-click-area {
    position: absolute;
    top:0;
    right:0;
    height: 100%;
    width: gcv-nav(accordion/click-area-size);
    cursor: pointer;
  }
}

@mixin w-nav-options {
  // horizontal menu
  &.wo-horizontal {
    & > li { float: left; }
    // disable marker animation for top level horizontal menu
    & > li > .w-state-active .w-nav-parent-marker {
      transform: rotate(0deg);
    }

    // separators
    &.wo-separators {
      $height: gcv-nav(separator/height);
      $spacing: gcv-nav(separator/spacing);
      $style: gcv-nav(separator/style);

      & {
        li:before {
          content: "";
          display: inline-block;
          position: absolute;

          width: 1px;
          height: $height;
          top: 50%;
          left: -1px - px($spacing);
          transform: translateY(-50%);
        }
        li:not(:first-child) {
          margin-top: 0;
          margin-left: px($spacing) * 2;
          &:before {
            margin: 0 1px;
            border-left: $style;
          }
        }
      }
    }
  }
  // icon menu
  &.wo-icon > li {
    & > a {
      font-size: gcv-nav(icon/font-size);
      font-weight: gcv-nav(icon/font-weight);
      padding: gcv-nav(icon/padding);
    }
  }

  &.wo-dropdown { @include w-nav-dropdown-core; }
  &.wo-accordion { @include w-nav-accordion-core; }
}

@mixin w-nav-styles($conf:()) {
  $conf:            map-extend((), $w-conf-nav, $conf, true);
  $bg:              gcv($conf, bg);
  $text-fg:         gcv($conf, item-wrapper/fg);
  $text-bg:         gcv($conf, item-wrapper/bg);
  $hover-fg:        gcv($conf, 'item-wrapper/hover/fg');
  $hover-bg:        gcv($conf, 'item-wrapper/hover/bg');

  & {
    background-color: $bg;
  }
  li {
    a {
      color: $text-fg;
      background: $text-bg;
    }
    &:hover > a {
      color: $hover-fg;
      background: $hover-bg;
    }
  }
}

//-----------------------------------------------
//  class generation
//-----------------------------------------------
@if $w-wicle-mode != 'scss' and $w-nav-generate-classes {
  .w-nav {
    @include w-nav-core;
    @include w-nav-options;
    @include w-nav-styles;
  }
}
@if mixin-exists(w-hook-nav) { @include w-hook-nav(); }